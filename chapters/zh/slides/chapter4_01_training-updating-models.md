---
type: slides
---

# 模型的训练和更新

Notes: 欢迎来到最后一章，我们来学习现代自然语言处理最激动人心的部分：
训练我们自己的模型！

本节课中，我们要学习训练和更新spaCy的神经网络模型及其相应的数据，我们主要专注于命名
实体识别器这一部分。

---

# 为什么要更新模型？

- 对特定领域有更好的结果
- 对特定问题学习特定的分类类别
- 对文本分类非常必要
- 对命名实体识别非常有用
- 对词性标注和依存关系识别不是很关键

Notes: 我们介绍 _如何_ 更新模型之前先花一点时间问问我们自己：为什么我们想要
用我们自己的例子来更新模型？我们是不是只用预训练好的模型就可以了？

统计模型可以基于相应的训练数据来做预测。

给模型更多我们自己特定领域的数据通常可以让模型预测更准确。

我们经常需要预测一些和我们特定问题相关的类别，所以模型也需要学习。

更新模型对文本分类十分必要，对实体识别也非常有用，但对词性标注和依存句法分析就没有
那么关键了。

---

# 如何训练(1)

1. **初始化**模型权重使之变为随机值：调用`nlp.begin_training`方法
2. **预测**几个例子，看看当前权重的表现：调用`nlp.update`方法
3. **比较**预测结果和真实标注的标签
4. **计算**如何调整权重来改善预测结果
5. **微调**模型权重
6. 重复步骤2。

Notes: spaCy支持用更多的例子来更新现有模型训练新模型。

如果我们不是用一个预训练模型做初始模型的话，我们首先需要随机化所有的权重。

然后我们调用`nlp.update`，这个方法使用当前权重来预测一批次的例子。

模型然后把预测结果和正确答案做比较，决定下一步应该如何改变模型权重来使得下一次的
预测结果表现更好。

最后我们对当前权重做出微调，然后在下一个批次的例子上做预测。

我们对数据中的每一批例子调用`nlp.update`。

---

# 如何训练(2)

<img src="/training.png" alt="训练流程图表" />

- **训练数据：**例子及其标注
- **文本：**输入文本，模型会在这些文本上做标签预测。
- **标签：**模型需要预测的标签
- **梯度：**权重如何微调

Notes: 我们来看看模型训练的过程。

训练数据是我们想要用来更新模型的输入例子。

文本应该是一个句子、一个段落或者更长的文档。要得到最好的结果，这些文本应该
尽可能与模型将要在生产环境中预测的文本格式相似。

标签是我们想让模型预测的结果。标签可以是一个文本类别，或者是一个实体的跨度span及其
类别。

梯度决定了我们应该如何微调模型来减少当前的错误。我们通过比较模型预测标签和真实标签
来计算梯度。

训练结束后，我们就可以保存更新过的模型，在实际应用中使用它了。

---

# 举例：训练实体识别器

- 实体识别器可以对词语和短语做基于语境的实体识别
- 每一个词符只能是某一个实体的一部分
- 训练例子需要带有语境

```python
("iPhone X is coming", {"entities": [(0, 8, "GADGET")]})
```

- 并非实体的文本部分也非常重要

```python
("I need a new phone! Any tips?", {"entities": []})
```

- **目标：**让模型学会泛化

Notes: 我们来看一个例子，专注于一个特定的组件：实体识别器。

实体识别器读入一个文档，预测其中的短语及其标签。这意味着训练数据需要有文本、
包含的实体以及实体的标签。

实体之间不能重叠，所以一个词符只能属于一个实体。

因为实体识别器要 _在语境中_ 预测实体，我们要用实体 _加上_ 实体周围的语境来训练它。

最简单的方法就是给模型输入一段文本和一个字符位置的列表。比如"iPhone X"是一个电子产品，
是从字符0开始到字符8结束的。

让模型知道哪些词 _并不是_ 实体也是非常重要的。

这种情况下，span标注的列表会是空的。

我们的目标是教会模型在相似语境中识别出新的实体，就算这些实体并没有在训练数据中出现过。


---

# 训练数据

- 一系列我们希望模型在语境中做出预测的例子
- 更新**现有模型**：需要几百到几千个例子
- 训练**新的类别**：需要几千乃至几百万个例子
  - spaCy的英文模型是在200万个词语的语料规模上训练的
- 通常需要由标注师人工标注数据
- 也可以是半自动的，比如用spaCy的模板匹配器`Matcher`！

Notes: 训练数据告诉模型我们想要预测什么。预测目标可能是想要识别的文本和命名
实体，或者是词符及其正确的词性标签。

要更新一个现有的模型，我们可以先试试几百到几千数据量的例子。

要训练一个新的类别我们可能需要百万级别的训练数据。

spaCy的预训练英文模型是在200万个词汇的语料上训练的，这些文本都已经标注了词性标签、
依存关系和命名实体。

训练数据通常是由训练师手动标注文本创建的。

数据标注是一项繁重的任务，但也可以半自动化进行，比如用spaCy的模板匹配器`Matcher`。

---

# 上手练习吧！

Notes: 是时候开始准备一些训练数据了。我们来看看几个例子，为一个新的实体类别
创建一个小的训练数据集。
